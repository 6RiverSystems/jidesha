var meetingId = "";
var BASE_URL = "https://meet.jit.si/";
var APP_NAME = "Jitsi";
// Numbers used to access the service, will be listed in the autogenerated
// description of the event when adding a meeting to an event.
var NUMBERS = [];
var generateRoomNameAsDigits = false;

/**
 * The event page we will be updating.
 */
class EventContainer {
    constructor() {
    }

    /**
     * @returns {EventContainer}
     */
    static getInstance() {
        var eventEditPage = document.querySelector('#maincell #coverinner');
        if (eventEditPage)
            return new GEvent(eventEditPage);
        else
            return null;
    }

    /**
     * The description of the event.
     * @returns {Description}
     */
    get description() {}

    /**
     * The button container where we will add the jitsi button.
     */
    get buttonContainer() {}

    /**
     * The location of the event.
     * @returns {Location}
     */
    get location() {}

    /**
     * The container element of the event edit page.
     * @returns {*}
     */
    get container(){
        return this.containerElement;
    };

    set container(c){
        this.containerElement = c;
    };

    update() {}

    /**
     * Checks for the button on current page
     */
    isButtonPresent() {
        return ($('#jitsi_button').length >= 1);
    }

    /**
     * Checks if there is meetingId, if not generate it, otherwise return it.
     * @returns {string} the meeting id to use.
     */
    getMeetingId() {
        var meetingId = "";
        var inviteText = this.location.text;

        var ix = inviteText.indexOf(BASE_URL);
        var url;
        if (ix != -1 && (url = inviteText.substring(ix)) && url.length > 0) {
            meetingId = url.substring(BASE_URL.length);

            // there can be ',' after the meeting, normally added when adding
            // physical rooms to the meeting
            var regexp = /([a-zA-Z]+).*/g;
            var match = regexp.exec(meetingId);
            if (match && match.length > 1)
                meetingId = match[1];
        }
        else {
            if (generateRoomNameAsDigits) {
                meetingId = randomDigitString(10);
            }
            else
                meetingId = generateRoomWithoutSeparator();
        }

        return meetingId;
    }

    /**
     * Adds the jitsi button in buttonContainer.
     */
    addsJitsiButton() {
        var container = this.buttonContainer;
        if (!container)
            return;

        var description = this.description;

        if (!description.element)
            return;

        container.addClass('button_container');
        container.append(
            '<div id="jitsi_button"><a href="#" style="color: white"></a></div>');
        // container.find('div.ui-sch').addClass('hangouts_button');
        description.update(this.location);
    }
}

/**
 * Represents the location field.
 */
class Location {
    /**
     * The text in the location field.
     */
    get text() {}

    /**
     * A text to be used when adding info to the location field.
     * @returns {string}
     */
    static getLocationText() {
        return APP_NAME + ' Conference';
    }

    /**
     * Adds location info.
     * @param text
     */
    addLocationText(text){}
}

/**
 * Represents the description of the event.
 */
class Description {
    /**
     * Updates the description and location field is not already updated.
     * @param location
     */
    update(location) {
        var isDescriptionUpdated = false;

        // checks whether description was updated.
        if (this.element != undefined) {
            var descriptionContainsURL =
                (this.value.length >= 1 && this.value.indexOf(BASE_URL) !== -1);
            isDescriptionUpdated =
                descriptionContainsURL ||
                // checks whether there is the generated name in the location input
                (location.text.indexOf(Location.getLocationText()) != -1);
        }

        if(isDescriptionUpdated) {
            // update button url of event has all the data
            updateButtonURL();
        } else {
            // update button as event description has no meeting set
            var button = $('#jitsi_button a');
            button.html('Add a ' + APP_NAME + ' Meeting');
            button.attr('href', '#');
            button.on('click', e => {
                e.preventDefault();

                if (!isDescriptionUpdated) {
                    // Build the invitation content
                    this.addDescriptionText(getInviteText());
                    updateButtonURL();

                    location.addLocationText(
                        Location.getLocationText() + ' - '
                            + $('#jitsi_button a').attr('href'));
                }
                updateButtonURL();
            });
        }
    }

    /**
     * The description html element.
     */
    get element() {}

    /**
     * The text value of the description of the event.
     */
    get value() {}

    /**
     * Adds description text to the existing text.
     * @param text
     */
    addDescriptionText(text){}
}

/**
 * The google calendar specific implementation of the event page.
 */
class GEvent extends EventContainer {
    constructor(eventEditPage) {
        super();

        this.container = eventEditPage;
    }

    /**
     * Updates content (adds the button if is not there).
     * This is the entry point for all page modifications.
     */
    update() {
        if ($('table.ep-dp-dt').is(":visible")) {
            meetingId = this.getMeetingId();

            if(!this.isButtonPresent())
                this.addsJitsiButton();
        }
    }

    /**
     * The event location.
     * @returns {GLocation}
     */
    get location() {
        return new GLocation();
    }

    /**
     * The button container holding jitsi button.
     * @returns {*}
     */
    get buttonContainer() {
        var container = $(getNodeID('rtc'));
        if(container.length == 0)
            return null;
        return container;
    }

    /**
     * The event description.
     * @returns {GDescription}
     */
    get description() {
        return new GDescription();
    }

    /**
     * Adds the jitsi button.
     */
    addsJitsiButton() {
        super.addsJitsiButton();

        var rtcRow = $(getNodeID('rtc-row'));
        if(rtcRow.is(':visible') == false && description.length != 0) {
            rtcRow.show();
            this.buttonContainer.addClass('solo');
        }
    }
}

/**
 * The google calendar specific implementation of the location field in the
 * event page.
 */
class GLocation extends Location {
    constructor() {
        super();
        this.elem = $('[id*=location].ep-dp-input input');
    }

    /**
     * The text from the location input field.
     * @returns {*}
     */
    get text() {
        return this.elem.val();
    }

    /**
     * Adds text to location input.
     * @param text
     */
    addLocationText(text){
        // Set the location if there is content
        var locationNode = this.elem[0];
        if (locationNode) {
            locationNode.dispatchEvent(getKeyboardEvent('keydown'));
            locationNode.value = locationNode.value == '' ?
                text : locationNode.value + ', ' + text;
            locationNode.dispatchEvent(getKeyboardEvent('input'));
            locationNode.dispatchEvent(getKeyboardEvent('keyup'));
            var changeEvt2 = document.createEvent("HTMLEvents");
            changeEvt2.initEvent('change', false, true);
            locationNode.dispatchEvent(changeEvt2);
        }
    }
}

/**
 * The google calendar specific implementation of the description textarea in
 * the event page.
 */
class GDescription extends Description {
    constructor() {
        super();

        var description = $(getNodeID('descript textarea'))[0];
        var descriptionRow = $(getNodeID('descript-row'));

        if (descriptionRow.find('textarea').length === 0)
            return;

        this.element = description;
    }

    /**
     * The html element.
     * @returns {*}
     */
    get element() {
        return this.el;
    }

    set element(el) {
        this.el = el;
    }

    /**
     * The text value of the description.
     */
    get value() {
        return this.el.value;
    }

    /**
     * Adds text to the description.
     * @param text
     */
    addDescriptionText(text){
        this.el.dispatchEvent(getKeyboardEvent('keydown'));
        this.el.value = this.el.value + text;
        this.el.dispatchEvent(getKeyboardEvent('input'));
        this.el.dispatchEvent(getKeyboardEvent('keyup'));
        var changeEvt1 = document.createEvent("HTMLEvents");
        changeEvt1.initEvent('change', false, true);
        this.el.dispatchEvent(changeEvt1);
    }
}

/**
 * Returns the node id.
 */
function getNodeID(name) {
    var inputNodePrefix = '';
    var labelNode = $("[id*='location-label']");
    if (labelNode.length >= 1) {
        inputNodePrefix = labelNode[0].id.split('.')[0];
    }
    return '#\\' + inputNodePrefix + '\\.' + name;
}

/**
 * Returns an event object that can be used to be simulated
 */
function getKeyboardEvent(event) {
    var keyboardEvent = document.createEvent('KeyboardEvent');
    var initMethod = typeof keyboardEvent.initKeyboardEvent !== 'undefined' ?
        'initKeyboardEvent' : 'initKeyEvent';
    keyboardEvent[initMethod](
        event // event type (keydown, keyup, or keypress)
        , true // bubbles
        , true // cancel-able
        , window // viewArg (window)
        , false // ctrlKeyArg
        , false // altKeyArg
        , false // shiftKeyArg
        , false // metaKeyArg
        , 32 // keyCodeArg
        , 0 // charCodeArg
    );

    return keyboardEvent;
}

/**
 * Generates description text used for the invite.
 * @returns {String}
 */
function getInviteText() {
    var inviteText =
        "Click the following link to join the meeting from your computer: "
        + BASE_URL + meetingId;

    if (NUMBERS.length > 0) {
        inviteText += "\n\n=====";
        inviteText +="\n\nJust want to dial in on your phone? ";
        inviteText += " \n\nCall one of the following numbers: ";
        NUMBERS.forEach(function (num) {
            inviteText += "\n" + num;
        });
        inviteText += "\n\nSay your conference name: '" + meetingId
            + "' and you will be connected!";
    }

    return inviteText;
}

/**
 * Updates the url for the button.
 */
function updateButtonURL() {
    try {
        $('#jitsi_button').addClass('join');
        var button = $('#jitsi_button a');
        button.html("Join " + meetingId + " now");
        button.off('click');
        button.attr('href', BASE_URL + meetingId);
        button.attr('target', '_new');
        button.attr('style', '{color:blue}');
    } catch (e) {
        console.log(e);
    }
}

/**
 * Checks whether it is ok to add the button to current page and add it.
 */
function checkAndUpdateCalendar() {
    var MutationObserver
        = window.MutationObserver || window.WebKitMutationObserver;
    var c = EventContainer.getInstance();
    if (c) {
        new MutationObserver(function(mutations) {
            try {
                mutations.every(function() {
                    c.update();
                });
            } catch(e) {
                console.log(e);
            }
        }).observe(c.container, {
            childList: true, attributes: true, characterData: false });
    }
}

checkAndUpdateCalendar();
